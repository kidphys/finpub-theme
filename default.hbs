<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">

	<title>{{meta_title}}</title>

	<meta name="HandheldFriendly" content="True">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <link rel="shortcut icon" href="{{asset "/favicon.ico"}}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.7.5/css/bulma.min.css">
  <script type="text/javascript">
		window.nativeFetch = fetch;
  </script>
  <script defer src="https://use.fontawesome.com/releases/v5.3.1/js/all.js"></script>
  <link rel="stylesheet" href="{{asset "css/font-awesome.min.css"}}">
	<link rel="stylesheet" href="{{asset "css/screen.css"}}">
	<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Merriweather:400,700%7CUbuntu:400,700">
	<style>
		{{!-- hacky way to disable bulmin list-style --}}
		ul {
			list-style: disc;
		}
		.hidden {
			display: none !important;
			visibility: hidden !important;
		}
		.image {
			width: 100%;
		}

		.user-info {
			position: relative;
			clear: right;
			float: left;
			top: -25px;
			left: 7px;
			font-size: smaller;
			color: grey;
		}

		@media only screen and (max-width: 768px) {
			.user-info {
				top: -11px;
			}
		}

		#main-navigation {
			float: left !important;
		}

		#authentication {
			margin-right: 100px;
			float: right;
		}
		.mobile-authentication {
			display: none;
		}

		{{!-- hiding login button in smaller screen --}}
		@media (max-width: 991px) {
			#authentication {
				display: none;
			}

			.mobile-authentication {
				display: block;
			}
		}

	</style>

	<script>
		{{> config}}
	</script>

	{{ghost_head}}
</head>
<body class="{{body_class}}">

	<div id="wrapper">

		{{navigation}}

		{{#is "home"}}
			{{> featured-posts}}
		{{/is}}

		{{{body}}}

		{{> media-feed}}

		{{> footer}}

	</div>

	{{ghost_foot}}

	<script src="{{asset "js/jquery-2.1.4.min.js"}}"></script>
	<script src="{{asset "js/slick.min.js"}}"></script>
	<script src="{{asset "js/velocity.min.js"}}"></script>
	<script src="{{asset "js/jquery.fitvids.js"}}"></script>
	<script src="{{asset "js/jquery.ghostrelated.min.js"}}"></script>
	<script src="{{asset "js/instafeed.min.js"}}"></script>
	<script src="{{asset "js/functions.js"}}"></script>
	<script type="text/javascript">
		jQuery(document).ready( function($) {
			$('#phonenumber').on('input', function(){
				console.log('input change', $(this).val())
			});

			console.log('Current user if in payment page', window.finpub.currentUser())
		});

		function sanitize_email(email) {
			return email.replace("@", " at ").replace(".", " ");
		}

		function changePaymentType(e) {
			e.preventDefault();
			e.stopPropagation();
			if (e.currentTarget.className.indexOf('is-active') < 0) {
				// set it as active.
				var dom = e.currentTarget,
					parent = e.currentTarget.parentElement,
					active = parent.querySelector('.is-active');
				active.className = active.className.replace('is-active', '');
				dom.className += ' is-active';
				var payType = dom.dataset['paymentType'];
				var allPayments = document.querySelectorAll('.payment-body');
				for (var i = 0; i < allPayments.length; i++) {
					var p = allPayments[i];
					// if (p.className.indexOf(payType.toLowerCase()) < 0)
					//     p.style.display = 'none';
					// else
					//     p.style.display = 'block';
					if (p.dataset['paymentType'] === payType) {
						p.className = p.className.replace('hidden');
					}
					else {
						if (p.className.indexOf('hidden') < 0)
							p.className += ' hidden';
					}
				}
				// Update the value of payment type ?
				// var payTypeInput = document.getElementById('id_payment_type');
				// payTypeInput.value = payType;

				// Update the transfer description
				var transferPrefix = document.getElementById('transfer_prefix');
				var user = window.finpub.currentUser() || {};
				if (user.email) {
					var email = sanitize_email(user.email);
					transferPrefix.innerText = email + " finpub "
				}
				else {
					transferPrefix.innerText = "please login";
				}
			}
			return false;
		}

		function copyToClipboard(val) {
			console.log('copy to clipboard', val)
			var dom = document.getElementById('clipboard');
			dom.value = val;
			dom.select();
			document.execCommand('copy');
			console.log('done copy');
		}

		function copyText(event) {
			event.stopPropagation();
			event.preventDefault();
			var dom = event.currentTarget,
				parent = dom.parentElement.parentElement;

			var contentNode = parent.querySelector('.bank_transfer__value');
			copyToClipboard(contentNode.innerText);
			return false;
		}
		console.log("setting finpub");
		window.onFinpubReady = function(finpub) {
			window.hasLoggedIn = false;
			finpub.init(window.location);

			function refreshLoginBtnWithId(id) {
				let loginBtn = document.getElementById(id);
				loginBtn.innerText = window.hasLoggedIn ? "Logout" : "Login";
			}

			function refreshLoginBtn() {
				refreshLoginBtnWithId('loginBtn');
				refreshLoginBtnWithId('loginMobileBtn');
			}

			function refreshUserProfileWithId(user, id) {
				let userInfo = document.getElementById(id)
				if (!userInfo) {
					console.warn('User Info element could not be found');
					return;
				}
				if (user) {
					userInfo.innerText = user.email;
				} else {
					userInfo.innerText = "";
				}
			}

			function refreshUserProfile(user) {
				refreshUserProfileWithId(user, 'user-info');
				refreshUserProfileWithId(user, 'user-info-mobile');
			}

			function setupLoginBtn(id) {
				let loginBtn = document.getElementById(id);
				if (loginBtn) {
					loginBtn.addEventListener('click', e => {
						e.preventDefault();
						e.stopPropagation();
						if (window.hasLoggedIn) {
							finpub.signout(function(info) {
								console.log("User has logged out successfully", info);
								window.hasLoggedIn = false;
								refreshLoginBtn();
								refreshUserProfile();
							});
						}
						else {
							finpub.signin(function(user) {
								if (user) {
									console.log("User has logged in successfully", user);
									window.hasLoggedIn = true;
									document.getElementById('user-info').innerText = user.email;
									refreshLoginBtn();
									refreshUserProfile(user);
								}
							});
						}
					});
				}
			}

			setupLoginBtn('loginBtn');
			setupLoginBtn('loginMobileBtn');
			console.log("onFinpubReady");
			var loginPromise = finpub.getLoginInfo()
			loginPromise.then(user => {
				if (user) {
					console.log("User has logged in");
					window.hasLoggedIn = true;
					refreshLoginBtn();
					refreshUserProfile(user)
				}
				else {
					console.warn("Auth request success but 'user' is not returend??");
				}
			})
			loginPromise.catch(e => {
				console.log("User has not logged in");
				window.hasLoggedIn = false;
				refreshLoginBtn();
				refreshUserProfile();
			})

		};

	</script>
	{{> facebook}}
	{{> disqus}}

</body>
</html>